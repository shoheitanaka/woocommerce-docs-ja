---
post_title: Logging in WooCommerce
sidebar_label: Logging
---
# WooCommerceでのログ記録

WooCommerceには、開発中のデバッグ、本番環境でのエラーの検出、または特定のイベントが発生した際の通知の送信に使用できる、独自の堅牢なロギングシステムがあります。デフォルトでは、WooCommerceはこのロガーを使用して、エラー、警告、およびストアの問題のトラブルシューティングに役立つ可能性のあるその他の通知を記録します。WooCommerceの多くのエクステンションも同様の目的でロガーを使用します。

## ログを見る

ロガーによって作成されたエントリは、**WooCommerce > Status > Logs** で表示できます。ログ表示インターフェースは、どのログ保存方法が設定されているかによって異なります（下記の「ロガーの設定」セクションを参照）。

### ファイルシステム

デフォルトのファイルシステム保存方法では、最初に表示されるのは既存のログファイルのリストです：

![ログファイルのリストを表示するデフォルトのログ閲覧インターフェース](/img/doc_images/file-browse.png)

ログファイルの名前は、エントリのソース（拡張子またはWooCommerceコードベースの一部）とエントリが生成された日付に基づいています。このファイルブラウジングビューでは、様々な方法でファイルを並べ替えることができ、特定のソースからのものだけを表示するようにフィルタリングすることもできます。ファイルをクリックすると、実際のログエントリを見ることができる単一ファイルビューに移動します：

![ログファイルの中身](/img/doc_images/file-view-new.png)

ファイルの行番号をクリックすると、その行がハイライトされます。これは、他の場所からファイルの特定の行にリンクするためにも使用できます。

ファイルブラウザビューから、ログファイルのリストを並べ替えたり、フィルタリングしたり、それらのファイルの内容から文字列を検索することができる：

![検索結果のリスト](/img/doc_images/search-results.png)

検索結果の行番号をクリックすると、単一ファイルビューのその行に移動します。

### データベース

データベース保存方式では、最新のものから順にログエントリーのリストが表示されます：

![ログ・エントリーがデータベースに保存されている場合のログ表示インターフェース](/img/doc_images/database-logs.png)

これらのエントリは、タイムスタンプ、レベル、およびソースによってソートすることができ、特定のソースまたは最小レベルのみを表示するようにフィルタリングすることもできます。また、ログエントリーのメッセージフィールド内の文字列を検索することもできます。

## ロガーの設定

Logs 画面の **WooCommerce > Status > Logs** から、"Settings" リンクをクリックして設定を変更してください：

![ログ設定画面](/img/doc_images/settings.png)

### Logger

すべてのログをオフにするには、ここのチェックボックスをオフにします。ロギングはあなたのサイトで何が起こっているかについての貴重な情報を提供することができるので、これはほとんどの状況ではお勧めしません！

### ログ保存

WooCommerceには2種類のログ保存方法が用意されています：

* **ファイル・システム** - ログ・エントリーはファイルに記録される。ファイルは、ログ・エントリーの`source`値（下記の「ログの追加」セクションを参照）と現在の日付によって区別されます。ファイルは、サイトの`uploads`ディレクトリの`wc-logs`サブディレクトリに保存されます。カスタム・ディレクトリは`woocommerce_log_directory`フィルター・フックを使って定義できます。ログファイルのサイズは5MBまでで、それ以降は回転します。
* **データベース** - ログ・エントリーは`{$wpdb->prefix}woocommerce_log`テーブルに記録されます。

この設定を変更し、すでにいくつかのログエントリーがある場合、それらのエントリーは他の保存方法に移行されませんが、削除もされません。

### 保存期間

ロガーは、スペースの節約として、この期間より古いログを定期的に調べて 削除します。ログ・エントリーがファイル・システムに保存されている場合、保存期間を 超えたログ・ファイル全体が削除されますが、データベース・ストレージの場合、 個々のログ・エントリーが削除されます。

### レベルのしきい値

各ログエントリには重大度レベルがある（下記の「ログの追加」セクションを参照）。これは最小の重大度レベルを設定し、最小レベル以上でないログエントリは記録されません。この設定は注意して使用してください！

この設定が "None "に設定されている場合、重大度レベルに関係なく、すべてのログエントリーが記録されることを意味する。

## ログの追加

ログは`WC_Logger`クラスのメソッドによって追加される。このクラスのインスタンスには `wc_get_logger()` 関数を使用してアクセスします。ログ・エントリーを追加する基本的な方法は、[`WC_Logger::log( $level, $message, $context )`](https://woocommerce.github.io/code-reference/classes/WC-Logger.html#method_log)です。また、ログの重要度レベルごとに、例えば `WC_Logger::warning( $message, $context )` のようなショートカット・メソッドがあります。一般的な`log`メソッドではなく、ショートカット・メソッドを使用することが望ましいです。

### Level

ログには8つの異なる重大度レベルがある：

* `emergency`
* `alert`
* `critical`
* `error`
* ラインコード
* インラインコード
* インラインコード
* インラインコード7

これらのレベルは、ログ・エントリがどの程度重要であるかをサイト所有者に示すだけでなく、ログをフィルタリングすることもできます。`error`以上の深刻度のログ・エントリのみを記録したい場合、ログ設定画面でしきい値を設定できます（上記の「ロガーの設定」を参照）。

このしきい値は、どのログハンドラが使用されているかに関係なく、全てのログに適用されることに注意してください。例えば、`WC_Log_Handler_Email` クラスは、独自のしきい値設定を持っていますが、これはグローバルしきい値の二次的なものです。

### メッセージ

メッセージはログエントリーの主な内容です。ログを見る人が誰でも理解できるようにしましょう！

### コンテキスト

context パラメータは、ログエントリに関連する追加の構造化データを格納するために使用されます。例えば、注文に関するログエントリーに、関連する注文オブジェクトの内容を含めることができます。ロガーがエントリーを生成するとき、context パラメーターのデータは、保存される前に JSON に変換されます。そのため、複数のコンテキストデータを追加したい場合は、 それぞれをコンテキスト配列内の別のキーとして追加する必要があります。

コンテキストの配列に追加することで、特別な動作を引き起こす特定のキーが2つある：

#### `source`

すべてのログエントリーに、`source`値をcontextパラメータに含めることを推奨します。`source`は、アプリケーションやコードベースのどこでログが生成されたかについてのコンテキストを提供することを意図しており、ログエントリをフィルタリングするために使用することができます。 

ソースが指定されていない場合、ロガーは、ログエントリが生成されたプラグインまたはファイルに基づいてソース値を生成します。

#### `backtrace`

コンテキストパラメータの `backtrace` キーを `true` に設定すると、ロガーは配列形式でバックトレース（スタックトレース）を生成します。これは特にエラー関連のログに便利で、ログエントリが生成されるまでに どのようなコードが実行されたかを知ることができます。

![ログファイルビューアに表示されるバックトレース](/img/doc_images/backtrace.png)

### 全例

```php
wc_get_logger()->info(
    'It is time for lunch.',
    array(
        'source'        => 'your_stomach',
        'backtrace'     => true,
        'previous_meal' => $elapsed_time_since_breakfast,
        'lunch_options' => array( 'fridge leftovers', 'bahn mi', 'tacos', 'pupusas' ),
    )
);
```

## ログのベストプラクティス

### ロギングの使用時期

* 予期せぬ問題のトラブルシューティングを支援する：
    * APIから予期しない値またはエラーを受信した。
    * システム内のデータが不正または破損している。
    * アプリケーションが予期しない、あるいは壊れた状態にある。
* プロセスの監査ログを保持する：
    * 注文メモのような、他の場所に保存されないトランザクションの詳細（しかし、そうあるべきかもしれない？）
    * データのインポートやエクスポートの結果。
    * 重要な設定が変更された。
    * 自動化されたプロセスでデータが変更または削除された。

### ロギングを使用しない場合

* メソッドやAPIの使い方が間違っていることを開発者に知らせる。これは大量の無駄なログを記録することになりかねません。エラーや例外 (`wc_doing_it_wrong()` など) の形ですぐにフィードバックしたほうがよいでしょう。

### ベストプラクティス

* `WC_Logger`の`log()`メソッドを直接使用するよりも、ログレベルに特化したラッパー・メソッドを使用する方が良いでしょう。例えば、 `info()` や `error()` などです。
* 完全にまとまった文章でメッセージを書きましょう。こうすることで、コードベースに詳しくない人にとっても、より有用なものになります。
* ログメッセージは翻訳可能であるべきではありません。メッセージを英語にしておくと、メッセージの内容から解決策を探すのが簡単になりますし、トラブルシューティングをする人がサイトオーナーと同じ言語を話せないかもしれないので、何が起こっているのかを理解しやすくなります。
* 理想的には、各ログエントリーメッセージは1行であるべきです（つまり、メッセージ文字列の中で改行しない）。追加の行や余分なデータは、コンテキスト配列に入れるべきです。
* メッセージ文字列の中に構造化データを出力するのは避けましょう。代わりにコンテキスト配列のキーに入れます。ロガーが JSON に変換し、ログビューアで読みやすくします。
* スタックトレースを含める必要がある場合は、ロガーが生成してくれます。
* 作業しているコンポーネントやシステムのソースを決定し、すべてのログ呼び出しにそれを使用します。こうすることで、そのコンポーネントに関連するすべてのログエントリを見つけやすくなり、 他の無関係なログエントリからフィルタリングしやすくなります。
* ループ内の各項目で別々のエントリーを追加するのではなく、ループした処理の後に、ループの結果を集約したログエントリーを1つ追加することを考慮してください。

## ロガーのカスタマイズ

### ロガークラス

`WC_Logger`クラスは、`woocommerce_logging_class`フィルターフックを使って別のクラスに置き換えることができます。代替クラスは[`WC_Logger_Interface`](https://woocommerce.github.io/code-reference/classes/WC-Logger-Interface.html)を実装していなければなりません。一般的には、ロガークラスそのものをオーバーライドするよりも、 カスタムログハンドラー（下記を参照）を作成する方が良いでしょう。

### ログハンドラ

WooCommerceでは、ログハンドラは生のログデータを受け取り、保存またはディスパッチ可能なログエントリに変換するPHPクラスです。WooCommerceには4つの異なるログハンドラクラスが同梱されています：

* `Automattic\\WooCommerce\\Internal\\Admin\\Logging\\LogHandlerFileV2`：これはデフォルトのハンドラであり、「ファイルシステム」ログ保存方法を表す。ファイルにログエントリーを記録する。
* `WC_Log_Handler_File`：inline_code_1__：これは古いデフォルトハンドラで、ログエントリーをファイルに記録します。将来的には非推奨となる可能性があり、このクラスの使用や拡張は推奨されません。
* inline_code_2__：このハンドラは「データベース」ログ保存メソッドを表します。このハンドラは、ログエントリーをデータベースに記録します。
* `WC_Log_Handler_Email`：このハンドラはログエントリーを保存しません。メールはサイト管理者のメールアドレスに送られます。このハンドラには[いくつかの制限事項](https://github.com/woocommerce/woocommerce/blob/fe81a4cf27601473ad5c394a4f0124c785aaa4e6/plugins/woocommerce/includes/log-handlers/class-wc-log-handler-email.php#L15-L27)があります。

#### ハンドラーの変更または追加

ファイルハンドラからデータベースハンドラに切り替えるには、ログ設定画面のオプションを更新するだけです。しかし、場合によっては、複数のログハンドラーを持ちたい場合や、ハンドラーの設定を変更したい場合があります。例えば、ほとんどのログをファイルに保存し、緊急エラーまたは重大エラーとして分類されたログエントリーは電子メールアドレスにも送信したい場合があります。この場合、`woocommerce_register_log_handlers` フィルタフックを使用して、使用したいログハンドラクラスインスタンスの配列を作成することができます。いくつかのハンドラクラスコンストラクタにはオプションのパラメータがあり、 クラスをインスタンス化するときにそれを使ってデフォルトの動作を変更することができます。

メールハンドラを追加する例です：

```php
function my_wc_log_handlers( $handlers ) {
	$recipients = array( 'wayne@example.com', 'garth@example.com' ); // Send logs to multiple recipients.
	$threshold  = 'critical'; // Only send emails for logs of this level and higher.
	$handlers[] = new WC_Log_Handler_Email( $recipients, $threshold );
	
	return $handlers;
}
add_filter( 'woocommerce_register_log_handlers', 'my_wc_log_handlers' );
```

#### カスタムハンドラの作成

ログを Slack チャンネルや InfluxDB のインスタンスなど、他の場所に送信するために独自のログハンドラクラスを作成することもできます。作成するクラスは [`WC_Log_Handler`](https://woocommerce.github.io/code-reference/classes/WC-Log-Handler.html) 抽象クラスを継承し、 [`WC_Log_Handler_Interface`](https://woocommerce.github.io/code-reference/classes/WC-Log-Handler-Interface.html) インターフェイスを実装しなければなりません。[`WC_Log_Handler_Email`](https://github.com/woocommerce/woocommerce/blob/6688c60fe47ad42d49deedab8be971288e4786c1/plugins/woocommerce/includes/log-handlers/class-wc-log-handler-email.php)ハンドラ・クラスは、この設定方法の良い例を提供します。

### ログファイルの保存場所

ファイルシステム」ログハンドラを使用する場合、デフォルトではログファイルはWordPress `uploads` ディレクトリの `wc-logs` サブディレクトリに保存されます。WooCommerceは`wc-logs`へのアクセスを防ぐために`.htaccess`ファイルを追加しますが、すべてのウェブサーバーがこのファイルを認識するわけではありません。オプションがある場合は、ログファイルをWebルート外のディレクトリに保存することを検討するとよいでしょう。そのディレクトリが`uploads`ディレクトリと同じユーザー／グループ権限を持っていることを確認して、WordPressがアクセスできるようにしてください。そして、`woocommerce_log_directory`フィルターフックを使用して、カスタムディレクトリへのパスを設定します。

### うるさいログを消す

頻繁に繰り返され、ログファイルを詰まらせている特定のログがある場合、なぜそのログがトリガーされ続けるのかを突き止め、その問題を解決すべきです。しかし、それが不可能な場合は、`woocommerce_logger_log_message`フィルターフックにコールバックを追加して、その特定のログを無視し、他のログを通過させることができます：

```php
function my_ignored_logs( $message, $level, $context, $handler ) {
	if ( false !== strpos( $message, 'Look, a squirrel!' ) ) {
		return null;
	}
	
	return $message;
}
add_filter( 'woocommerce_logger_log_message', 'my_ignored_logs', 10, 4 );
```

### ログUI

カスタムログハンドラーを作成し、ログ画面上にそのための独立したインターフェイスを構築したい場合、使用できるフィルターフックがいくつかある：

* `woocommerce_logger_handler_options`：このフィルターフックを使うと、設定画面の「ログ保存」オプションのリストにカスタムログハンドラーを追加することができます。この設定で、あなたのハンドラを選択し、それを「デフォルト」のログハンドラにしなければなりません。
* `wc_logs_render_page`：これは、独自のログインターフェイスをレンダリングするためにフックするアクションです。このアクションは、デフォルトのログハンドラが組み込みのハンドラ以外に設定されている場合にのみ実行されます。
* `wc_logs_load_tab`：inline_code_2__: このアクションは、Logs タブが最初にロードを開始したときに実行されます。フォーム投稿を処理するのに便利です。
